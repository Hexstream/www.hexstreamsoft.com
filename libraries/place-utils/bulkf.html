<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8" />
    <title>bulkf | place-utils | Libraries | HexstreamSoft</title>
    <link href="../../css/global.css" rel="stylesheet" type="text/css" />
    <link href="../libraries.css" rel="stylesheet" type="text/css" />
    <script src="http://use.edgefonts.net/sanvito-pro-display.js" async></script>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1783234-3']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>

    <nav id="site-nav">

      <nav class="breadcrumbs">
        <a href="../../">HexstreamSoft</a>
        <span class="separator"> » </span>
        <a href="../">Libraries</a>
        <span class="separator"> » </span>
        <a href="../categories/uncategorized/">Uncategorized</a>
        <span class="separator"> » </span>
        <a href="./">place-utils</a>
        <span class="separator"> » </span>
        <a class="here">bulkf</a>
        <div class="float-clear"></div>
      </nav>

      <nav class="ancestors-nav">

        <div class="level-separator"></div>

        <nav class="navbox" id="place-utils_navbox">
          <h1 class="box-header"><a href="./">place-utils</a></h1>
          <ul>
            <li><a href="setf-expanderlet.html">setf-expanderlet</a></li>
            <li><a href="with-resolved-places.html">with-resolved-places</a></li>
            <li><a href="updatef.html">updatef</a></li>
            <li>
              <a class="here">
                bulkf
                <span class="here-indicator-left"> </span>
                <span class="here-indicator-right"></span>
              </a>
            </li>
            <li><a href="funcallf-applyf.html">funcallf/applyf</a></li>
            <li><a href="cachef.html">cachef</a></li>
            <li><a href="oldf.html">oldf</a></li>
            <li><a href="readf.html">readf</a></li>
            <li><a href="tracef.html">tracef</a></li>
          </ul>
        </nav>

        <div class="level-separator"></div>

        <nav class="navbox" id="uncategorized-projects_navbox">
          <h1><a href="../categories/uncategorized/">Uncategorized</a></h1>
          <ul>
            <li><a href="../clhs/">clhs</a></li>
            <li>
              <a class="here">
                place-utils
                <span class="here-indicator-left"> </span>
                <span class="here-indicator-right"></span>
              </a>
            </li>
          </ul>
        </nav>

        <div class="level-separator"></div>

        <nav class="navbox" id="projects_navbox">
          <h1 class="box-header">
            <a href="../">Libraries</a>
          </h1>
          <ul>
            <li><a href="../categories/macros/">Macros</a></li>
            <li><a href="../categories/data-structures/">Data structures</a></li>
            <li>
              <a href="../categories/uncategorized/">
                Uncategorized
                <span class="here-indicator-left"> </span>
                <span class="here-indicator-right"></span>
              </a>
            </li>
          </ul>
        </nav>

        <div class="level-separator"></div>

        <nav class="navbox" id="main_navbox">
          <h1>
            <a href="../../">HexstreamSoft</a>
          </h1>
          <ul>
            <li><a href="../../introduction.html">Introduction</a></li>
            <li><a href="../">Libraries <span class="here-indicator-left"> </span> <span class="here-indicator-right"> </span></a></li>
            <li><a href="../../tweets/">Tweets</a></li>
            <li><a href="../../worknotes/">Worknotes</a></li>
            <li><a href="../../accounts/">Accounts</a></li>
            <li><a href="../../resources/">Resources</a></li>
          </ul>
        </nav>

      </nav>

    </nav>

    <div id="content">

      <header id="page-header">
        <h1>bulkf</h1>
        <p class="description">Flexible mass updating of places.</p>
      </header>

      <section>
        <h1>Description</h1>
        <dl>
          <dt><pre>Modify Macro <code class="common-lisp library macro operator">bulkf</code> <var>update-function-form</var> &amp;rest <var>mode-markers-and-items</var>
  &rArr; <var>results</var></pre></dt>
          <dd>
            <p><code class="common-lisp library macro operator">bulkf</code> allows mass updating of places.</p>
            <p><var>update-function-form</var> is evaluated first to produce <var>update-function</var>. The arguments and return values of this function depend on <var>mode-markers-and-items</var> and are described below.</p>
            <p><var>mode-markers-and-items</var> is a list of <var>mode-markers</var> and <var>items</var> to be processed from left to right at macroexpansion-time. A <var>mode-marker</var> is one of the symbols <code class="common-lisp library marker">:access</code>, <code class="common-lisp library marker">:read</code>, <code class="common-lisp library marker">:write</code> or <code class="common-lisp library marker">:pass</code>. Any other form is an <var>item</var>. Whenever a <var>mode-marker</var> is encountered, the mode with that name becomes the current mode and remains so until the next <var>mode-marker</var>. The current mode at the start of <var>mode-markers-and-items</var> is <code class="common-lisp library marker">:access</code> mode. There are 4 different types of <var>items</var>, corresponding to the 4 different modes that can be the current mode at the time the <var>item</var> is encountered. Here are the semantics of each type of item:</p>

            <dl>

              <dt><dfn><code class="common-lisp library marker">:access</code></dfn></dt>
              <dd><p><var>item</var> is a place that will be both read from and written to. At runtime, the subforms of the place are evaluated and the place is read. The primary value is contributed as an additional argument to <var>update-function</var>. <var>update-function</var> also returns an additional value that will be written back into the place (reusing the temporary variables bound to the results of the subforms).</p></dd>

              <dt><dfn><code class="common-lisp library marker">:read</code></dfn></dt>
              <dd><p><var>item</var> is a place that will be read from. At runtime, the subforms of the place are evaluated and the place is read. The primary value is contributed as an additional argument to <var>update-function</var>.</p></dd>

              <dt><dfn><code class="common-lisp library marker">:write</code></dfn></dt>
              <dd><p><var>item</var> is a place that will be written to. <var>update-function</var> returns an additional value that will be written into the place. The evaluation of the subforms of the place happens at the same time as it would have happened if the place had been read from.</p></dd>

              <dt><dfn><code class="common-lisp library marker">:pass</code></dfn></dt>
              <dd><p><var>item</var> is a form to be evaluated normally. Its primary value is passed as an additional argument to <var>update-function</var>.</p></dd>

            </dl>

            <p>If <var>update-function</var> returns more values than there are places to write to (<code class="common-lisp library marker">:access</code> and <code class="common-lisp library marker">:write</code> <var>items</var>), the additional values are ignored. If it returns less values than there are of these places, the remaining ones are set to <code class="common-lisp standard constant">nil</code>. <code class="common-lisp library macro operator">bulkf</code> returns the values that were written into these places. This might be more or less values than were returned by <var>update-function</var>. If a place to be written to has more than one store variable, the remaining such variables are set to <code class="common-lisp standard constant">nil</code> prior to evaluation of the storing form.</p>

            <p><code class="common-lisp library macro operator">bulkf</code> accepts an optional unevaluated argument before <var>update-function-form</var> (as very first argument). This must be the symbol <code class="common-lisp">funcall</code> or <code class="common-lisp">apply</code> and determines which operator will be used to call the <var>update-function</var> with its arguments. The default is <code>funcall</code>, which is expected to be used an overwhelming majority of the time. This is the reason this argument has not been made a normal required parameter.</p>

          </dd>

        </dl>
      </section>

      <section>
        <h1>Examples</h1>
        <p><code class="common-lisp library macro operator">bulkf</code> is very versatile and can be used to easily implement many different types of modify macros. Here are just a few examples:</p>
        <pre class="example"><code class="common-lisp">(<code class="common-lisp standard macro operator">defun</code> <var>bulkf-transfer</var> (<var>quantity</var> <var>source</var> <var>destination</var>)
  (<code class="common-lisp standard function operator">values</code> (<code class="common-lisp standard function operator">-</code> <var>source</var> <var>quantity</var>)
          (<code class="common-lisp standard function operator">+</code> <var>destination</var> <var>quantity</var>)))

(<code class="common-lisp standard macro operator">defmacro</code> <var>transferf</var> (<var>quantity</var> <var>source</var> <var>destination</var>)
  `(<code class="common-lisp library macro operator">bulkf</code> #'<var>bulkf-transfer</var>
          <code class="common-lisp library marker">:pass</code> ,<var>quantity</var>
          <code class="common-lisp library marker">:access</code> ,<var>source</var> ,<var>destination</var>))

(let ((<var>account-amounts</var> (<code class="common-lisp standard function operator">list</code> 35 90)))
  (<code class="common-lisp standard special-operator operator">multiple-value-call</code> #'<code class="common-lisp standard function operator">values</code>
    (<var>transferf</var> 10
               (<code class="common-lisp standard function operator">first</code> <var>account-amounts</var>)
               (<code class="common-lisp standard function operator">second</code> <var>account-amounts</var>))
    <var>account-amounts</var>))
&rArr; 25, 100, (25 100)</code></pre>
        <pre class="example"><code class="common-lisp">(<code class="common-lisp standard macro operator">defun</code> <var>bulkf-init</var> (<var>value</var> <var>number-of-places</var>)
  (<code class="common-lisp standard function operator">values-list</code> (<code class="common-lisp standard function operator">make-list</code> <var>number-of-places</var>
                          :initial-element <var>value</var>)))

(<code class="common-lisp standard macro operator">defmacro</code> <var>initf</var> (<var>value</var> &amp;rest <var>places</var>)
  `(<code class="common-lisp library macro operator">bulkf</code> #'<var>bulkf-init</var>
          <code class="common-lisp library marker">:pass</code> ,<var>value</var> ,(<code class="common-lisp standard function operator">length</code> <var>places</var>)
          <code class="common-lisp library marker">:write</code> ,@<var>places</var>))

(<code class="common-lisp standard special-operator operator">let</code> (<var>a</var> <var>b</var> (<var>c</var> (<code class="common-lisp standard function operator">make-list</code> 3 :initial-element nil)))
  (<var>initf</var> 0 <var>a</var> <var>b</var> (<code class="common-lisp standard function operator">second</code> <var>c</var>))
  (<code class="common-lisp standard function operator">values</code> <var>a</var> <var>b</var> <var>c</var>))
&rArr; 0, 0, (NIL 0 NIL)</code></pre>
        <pre class="example"><code class="common-lisp">(<code class="common-lisp standard macro operator">defun</code> <var>bulkf-spread</var> (<var>spread-function</var> <var>sum-function</var>
                     &amp;rest <var>place-values</var>)
  (<code class="common-lisp standard function operator">values-list</code>
   (let ((<var>number-of-places</var> (length <var>place-values</var>)))
     (<code class="common-lisp standard function operator">make-list</code> <var>number-of-places</var>
                :initial-element
                (<code class="common-lisp standard function operator">funcall</code> <var>spread-function</var>
                         (<code class="common-lisp standard function operator">apply</code> <var>sum-function</var> <var>place-values</var>)
                         <var>number-of-places</var>)))))

(<code class="common-lisp standard macro operator">defmacro</code> <var>spreadf</var> (<var>spread-function</var> <var>sum-function</var> &amp;rest <var>places</var>)
  `(<code class="common-lisp library macro operator">bulkf</code> #'<var>bulkf-spread</var> <code class="common-lisp library marker">:pass</code> ,<var>spread-function</var> ,<var>sum-function</var>
          <code class="common-lisp library marker">:access</code> ,@<var>places</var>))

(<code class="common-lisp standard special-operator operator">let</code> ((<var>a</var> 5) (<var>b</var> (<code class="common-lisp standard function operator">list</code> 10 18 20)))
  (<var>spreadf</var> #'<code class="common-lisp standard function operator">/</code> #'<code class="common-lisp standard function operator">+</code> <var>a</var> (<code class="common-lisp standard function operator">first</code> <var>b</var>) (<code class="common-lisp standard function operator">second</code> <var>b</var>))
  (<code class="common-lisp standard function operator">values</code> <var>a</var> <var>b</var>))
&rArr; 11, (11 11 20)

(<code class="common-lisp standard special-operator operator">let</code> ((<var>a</var> 2) (<var>b</var> (<code class="common-lisp standard function operator">list</code> 2 4 8)))
  (<var>spreadf</var> #'<code class="common-lisp standard function operator">*</code> #'<code class="common-lisp standard function operator">*</code> <var>a</var> (<code class="common-lisp standard function operator">first</code> <var>b</var>) (<code class="common-lisp standard function operator">second</code> <var>b</var>) (<code class="common-lisp standard function operator">third</code> <var>b</var>))
  (<code class="common-lisp standard function operator">values</code> <var>a</var> <var>b</var>))
&rArr; 512, (512, 512, 512)</code></pre>
        <pre class="example"><code class="common-lisp">(<code class="common-lisp standard macro operator">defun</code> <var>bulkf-map</var> (<var>function</var> &amp;rest <var>place-values</var>)
  (<code class="common-lisp standard function operator">values-list</code> (<code class="common-lisp standard function operator">mapcar</code> <var>function</var> <var>place-values</var>)))

(<code class="common-lisp standard macro operator">defmacro</code> <var>mapf</var> (<var>function</var> &amp;rest <var>places</var>)
  `(<code class="common-lisp library macro operator">bulkf</code> #'<var>bulkf-map</var> <code class="common-lisp library marker">:pass</code> ,<var>function</var> <code class="common-lisp library marker">:access</code> ,@<var>places</var>))

(<code class="common-lisp standard special-operator operator">let</code> ((<var>a</var> 0) (<var>b</var> 5) (<var>c</var> (<code class="common-lisp standard function operator">list</code> 10 15)))
  (<code class="common-lisp standard function operator">values</code> (<code class="common-lisp standard macro operator">multiple-value-list</code> (<var>mapf</var> #'<code class="common-lisp standard function operator">1+</code> <var>a</var> <var>b</var> (<code class="common-lisp standard function operator">second</code> <var>c</var>)))
          <var>a</var> <var>b</var> <var>c</var>))
&rArr; (1 6 16), 1, 6, (10 16)</code></pre>
        <pre class="example"><code class="common-lisp">(<code class="common-lisp standard macro operator">defun</code> <var>bulkf-steal</var> (<var>sum-function</var> <var>steal-function</var>
                    <var>initial-assets</var> &amp;rest <var>target-assets</var>)
  (<code class="common-lisp standard special-operator operator">let</code> (<var>stolen</var> <var>leftovers</var>)
    (<code class="common-lisp standard function operator">mapc</code> (<code class="common-lisp standard macro operator">lambda</code> (<var>assets</var>)
            (<code class="common-lisp standard macro operator">multiple-value-bind</code> (<var>steal</var> <var>leftover</var>)
                (<code class="common-lisp standard function operator">funcall</code> <var>steal-function</var> <var>assets</var>)
              (<code class="common-lisp standard macro operator">push</code> <var>steal</var> <var>stolen</var>)
              (<code class="common-lisp standard macro operator">push</code> <var>leftover</var> <var>leftovers</var>)))
          <var>target-assets</var>)
    (<code class="common-lisp standard function operator">values-list</code>
     (<code class="common-lisp standard function operator">cons</code> (<code class="common-lisp standard function operator">apply</code> <var>sum-function</var>
                  (<code class="common-lisp standard function operator">cons</code> <var>initial-assets</var> (<code class="common-lisp standard function operator">nreverse</code> <var>stolen</var>)))
           (<code class="common-lisp standard function operator">nreverse</code> <var>leftovers</var>)))))

(<code class="common-lisp standard macro operator">defmacro</code> <var>stealf</var> (<var>sum-function</var> <var>steal-function</var> <var>hideout</var> &amp;rest <var>targets</var>)
  `(<code class="common-lisp library macro operator">bulkf</code> #'<var>bulkf-steal</var> <code class="common-lisp library marker">:pass</code> ,<var>sum-function</var> ,<var>steal-function</var>
          <code class="common-lisp library marker">:access</code> ,<var>hideout</var> ,@<var>targets</var>))

(<code class="common-lisp standard special-operator operator">let</code> ((<var>cave</var> :initial-assets)
      (<var>museum</var> '(:paintings :collection))
      (<var>house</var> 20000)
      (<var>triplex</var> (list :nothing-valuable :random-stuff 400)))
  (<var>stealf</var> #'<code class="common-lisp standard function operator">list</code>
          (<code class="common-lisp standard macro operator">lambda</code> (<var>assets</var>)
            (if (eq <var>assets</var> :nothing-valuable)
                (values nil <var>assets</var>)
                (values <var>assets</var> (<code class="common-lisp standard special-operator operator">if</code> (<code class="common-lisp standard function operator">numberp</code> <var>assets</var>) 0 nil))))
          <var>cave</var> <var>museum</var> <var>house</var> (<code class="common-lisp standard function operator">first</code> <var>triplex</var>) (<code class="common-lisp standard function operator">second</code> <var>triplex</var>) (<code class="common-lisp standard function operator">third</code> <var>triplex</var>))
  (<code class="common-lisp standard function operator">values</code> <var>cave</var> <var>museum</var> <var>house</var> <var>triplex</var>))
&rArr;
(:INITIAL-ASSETS (:PAINTINGS :COLLECTION) 20000 NIL :RANDOM-STUFF 400)
NIL
0
(:NOTHING-VALUABLE NIL 0)</code></pre>
      </section>

    </div>

    <div id="footer">
      <div>
        <a href="#" class="back-to-top">⬆</a>
        <span class="page-badge"><a href="http://validator.w3.org/check?uri=http%3A%2F%2Fwww.hexstreamsoft.com%2Flibraries%2Fplace-utils%2Fbulkf.html"><span class="checkmark">✔</span> HTML5</a></span>
        <span class="page-badge"><a href="http://www.hexstreamsoft.com/README"><span class="checkmark">✔</span> Public Domain</a></span>
        <span class="page-badge"><a href="http://jigsaw.w3.org/css-validator/validator?uri=http%3A%2F%2Fwww.hexstreamsoft.com%2Flibraries%2Fplace-utils%2Fbulkf.html"><span class="checkmark">✔</span> CSS3</a></span>
      </div>
    </div>

  </body>
</html>
